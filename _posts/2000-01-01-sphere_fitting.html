---
layout: post
title: Fitting geometric models with gradient descent
date: 2018-06-14
category: Data-Science
tags:   Geometry Optimization
img: /notebooks/imgs/sphere_fitting/post_img.jpg
file: /notebooks/sphere_fitting.py
excerpt_separator: </p>
---
    
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The process of fitting known geometric models to scattered data is well known and resolved since a long time. 
Indeed, Legendre was one of the first to use least-square to do such tasks <cite><a href="#legendre1805nouvelles">[1]</a></cite>,
when he wanted to fit an equation for the shape of the earth !</p>
<p>The idea is quite simple: knowing the model definition, it is possible to estimate its best parameters 
that fits well to the input noisy data.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="tl;dr">tl;dr<a class="anchor-link" href="#tl;dr">¶</a></h2><ol>
<li>Mathematical model definition for your data</li>
<li>Cost function</li>
<li>Optimisation (gradient descent with cost function derivative on all the parameters)</li>
<li>Hyper-parameters optimisation with training set (learning rate)</li>
<li>Model bias with testing set</li>
</ol>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="1.-Optimisation">1. Optimisation<a class="anchor-link" href="#1.-Optimisation">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Given a mathematical model with parameters $\Theta$, we can define its minimization function $\xi(\Theta)$ (the inverse likelihood).
This represents the fitness of the model given some data, so if $\xi(\Theta)$ is minimum, then the parameters are best suited to the data.</p>
<p>To optimize the parameters, one could check every possible parameters $\Theta_i$ and compute directly $\xi(\Theta_i)$.
Unfortunately, with our current compute power, this is time consuming.
Especially if we have more than one parameter, then the manifold would be to large to explore.
Imagine the difference between exploring a one dimension line vs exploring a 3D surface!</p>
<p><img alt="manifold" src="/notebooks/imgs//sphere_fitting/manifold.svg" style="width: 200px;"/></p>
<p>This is why it is important to have a dynamic strategy to find the local minimum, and this can be done using gradients.
We can calculate the gradient of the energy function among our parameters:
\begin{equation}
\frac{\delta \xi(\Theta)}{\delta \Theta} = \nabla\xi(\Theta)
\end{equation}</p>
<p>The gradient of the energy function can then be used to update the parameter every step, and converge to a local minima:
\begin{equation}
\Theta(t+1) = \Theta(t) - \mu\nabla\xi(\Theta(t)) 
\end{equation}</p>
<p>One could compute directly the optimal solution by equalizing the gradient of energy function with 0:
\begin{equation}
\frac{\delta \xi(\Theta)}{\delta \Theta} = 0
\end{equation}</p>
<p>When this method works well with little data and few parameters, it can be computationnaly impossible to compute the best solution <a href="https://stats.stackexchange.com/questions/278755/why-use-gradient-descent-for-linear-regression-when-a-closed-form-math-solution">see this thread for more information</a>. 
Morevover, it is not always easy to mathematically extract the optimal parameters.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="2.-Example-with-sphere-fitting">2. Example with sphere fitting<a class="anchor-link" href="#2.-Example-with-sphere-fitting">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="2.1-Cost-function">2.1 Cost function<a class="anchor-link" href="#2.1-Cost-function">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To extract the cost function, we first need to define what is a sphere.
The equation of a 3D sphere with radius $r$ and center $(a, b, c)$ is known as:
\begin{equation}
r^2 = (x-a)^2 + (y-b)^2 + (z-c)^2
\end{equation}</p>
<p>Every point $(x,y,z)$ must satisfy this equation to be on the sphere, if not, the point is outside the sphere.
Using this condition, we can deduce the energy function:
\begin{equation}
\xi(\Theta) = \sum_i^n(L_i - r)^2
\end{equation}
with,
\begin{equation}
L_i = \sqrt{(x_i-a)^2 + (y_i-b)^2 + (z_i-c)^2}
\end{equation}
This function will verify if every known point $i$ fits well with the parameters $a, b, c$ and $r$.
Let's implement it in python !</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area collapsed"><div class="collapse_expand_button far fa-1x fa-minus-square"></div>
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">## imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>

<span class="c1"># fixing numpy random state for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
<div class="input_area"><div class="collapse_expand_button far fa-1x fa-minus-square"></div>
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">sph_loss</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">L</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
<div class="input_area"><div class="collapse_expand_button far fa-1x fa-minus-square"></div>
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">cost_function</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">sph_loss</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">L</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="2.2-Gradient-of-the-cost-function">2.2 Gradient of the cost function<a class="anchor-link" href="#2.2-Gradient-of-the-cost-function">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have the cost funtion, we can compute its gradient for every parameters (a, b, c, r). 
\begin{equation}
\nabla\xi(\Theta) =
  \begin{bmatrix}
  \frac{\delta \xi(\Theta)}{\delta r} \\
    \frac{\delta \xi(\Theta)}{\delta a} \\
    \frac{\delta \xi(\Theta)}{\delta b} \\
    \frac{\delta \xi(\Theta)}{\delta c} 
  \end{bmatrix}
\end{equation}</p>
<p>Then, with $m$ as the number of 3D points:</p>
\begin{equation}
\frac{\delta \xi(\Theta)}{\delta r} = -2\sum_{i=1}^m (L_i -r)
\end{equation}\begin{equation}
\frac{\delta \xi(\Theta)}{\delta a} = 2\sum_{i=1}^{m}((x_i-a) + r\frac{\delta L_i}{\delta a}); \qquad  \frac{\delta L_i}{\delta a} = \frac{a-x_i}{L_i}
\end{equation}\begin{equation}
\frac{\delta \xi(\Theta)}{\delta b} = 2\sum_{i=1}^{m}((y_i-b) + r\frac{\delta L_i}{\delta b}); \qquad  \frac{\delta L_i}{\delta b} = \frac{b-y_i}{L_i}
\end{equation}\begin{equation}
\frac{\delta \xi(\Theta)}{\delta c} = 2\sum_{i=1}^{m}((z_i-c) + r\frac{\delta L_i}{\delta c}); \qquad  \frac{\delta L_i}{\delta c} = \frac{c-z_i}{L_i}
\end{equation}
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In python,</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
<div class="input_area collapsed"><div class="collapse_expand_button far fa-1x fa-minus-square"></div>
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">## cost function derivative</span>
<span class="k">def</span> <span class="nf">derivative_cost_function</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">sph_loss</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    
    <span class="n">dr</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">L</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">)</span>
    
    <span class="n">dLa</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">L</span>
    <span class="n">da</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">dLa</span> <span class="p">)</span>
    
    <span class="n">dLb</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">L</span>
    <span class="n">db</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">dLb</span> <span class="p">)</span>
    
    <span class="n">dLc</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">L</span>
    <span class="n">dc</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">dLc</span> <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">da</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">dc</span><span class="p">,</span> <span class="n">dr</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="2.3-Gradient-descent">2.3 Gradient descent<a class="anchor-link" href="#2.3-Gradient-descent">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Using the gradient of the cost function, it is now possible to optimize the best parameters with gradient descent.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
<div class="input_area"><div class="collapse_expand_button far fa-1x fa-minus-square"></div>
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">grad_descent</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">param_init</span><span class="p">):</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">param_init</span> <span class="c1">#initial guess</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="mf">5e-3</span>
    <span class="n">it_max</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e99</span><span class="p">,</span> <span class="mf">1e99</span><span class="p">,</span> <span class="mf">1e99</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">it_max</span><span class="p">):</span> 
        <span class="k">if</span><span class="p">(</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">grad</span><span class="p">))</span><span class="o">&lt;</span><span class="mf">1e-6</span> <span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># gradient descent</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">derivative_cost_function</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">T</span> <span class="o">+</span> <span class="n">lr</span><span class="o">*</span><span class="n">grad</span>
        <span class="n">it_max</span> <span class="o">=</span> <span class="n">it</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Done in </span><span class="si">%d</span><span class="s2"> epochs with grad: [</span><span class="si">%1.4e</span><span class="s2">, </span><span class="si">%1.4e</span><span class="s2">, </span><span class="si">%1.4e</span><span class="s2">, </span><span class="si">%1.4e</span><span class="s2">]"</span> <span class="o">%</span><span class="p">(</span><span class="n">it_max</span><span class="p">,</span> <span class="n">grad</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">grad</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">grad</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">grad</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    
    <span class="k">return</span> <span class="n">T</span><span class="p">,</span> <span class="n">grad</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="2.4-Training-phase">2.4 Training phase<a class="anchor-link" href="#2.4-Training-phase">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We will first generated data for a standard 3D sphere, we can use spherical coordinates to sample random points given the sphere parameters. To reduce CPU time, we will not use a high number of points.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
<div class="input_area"><div class="collapse_expand_button far fa-1x fa-minus-square"></div>
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">gen_points_from_sph</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">res</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">res</span><span class="p">)</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">res</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span>
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's generate 250 points with gaussian noise, from an unknown sphere centered at (1,2,4) and 10 radius.
Then, we will use 2/3 of the data and try to find these parameters. Remember that the hyper-parameters for the gradient descent are supposed to be optimized during training set.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
<div class="input_area"><div class="collapse_expand_button far fa-1x fa-minus-square"></div>
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">#Training phase</span>
<span class="n">sph_model</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">150</span>
<span class="n">sph_points</span> <span class="o">=</span> <span class="n">gen_points_from_sph</span><span class="p">(</span><span class="n">sph_model</span><span class="p">,</span> <span class="n">n</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">sph_points_train</span> <span class="o">=</span> <span class="n">sph_points</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">3</span><span class="p">),:]</span>

<span class="n">param_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span> <span class="c1">#initial guess</span>

<span class="n">param</span> <span class="o">=</span> <span class="n">grad_descent</span><span class="p">(</span><span class="n">sph_points_train</span><span class="p">,</span> <span class="n">param_init</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># We use the formula for the radius</span>
<span class="nb">print</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Done in 451 epochs with grad: [7.5565e-07, 6.7974e-07, 4.6369e-08, -5.0762e-07]
[1.6254153  2.60214652 4.06164314 9.81725285]
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The optimization returned a sphere centered at (1.21, 2.09, 3.94) with 9.94 radius.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="2.5-Testing-phase">2.5 Testing phase<a class="anchor-link" href="#2.5-Testing-phase">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have an estimation on the model, we can test it and see how weel this model fits to the data. We use the 1/3 remaining points to estimate the error of the model.</p>
<p>The error estimation can be done using the fitting function $\xi(\Theta)$.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
<div class="input_area"><div class="collapse_expand_button far fa-1x fa-minus-square"></div>
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">#Testing phase</span>
<span class="n">sph_points_test</span> <span class="o">=</span> <span class="n">sph_points</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">3</span><span class="p">)::,:]</span>
<span class="n">model_error</span> <span class="o">=</span> <span class="n">cost_function</span><span class="p">(</span><span class="n">sph_model</span><span class="p">,</span> <span class="n">sph_points_test</span><span class="p">)</span><span class="o">/</span><span class="n">sph_points_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Model has an error of </span><span class="si">%.2f</span><span class="s2"> per point"</span><span class="o">%</span><span class="k">model_error</span>)
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Model has an error of 0.93 per point
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The error per point is quite high. But considering the noise that was introduced, we see that the algorithm performs quite well.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
<div class="input_area"><div class="collapse_expand_button far fa-1x fa-minus-square"></div>
<div class="highlight hl-ipython3"><pre><span></span><span class="n">model_error</span> <span class="o">=</span> <span class="n">cost_function</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">sph_points_test</span><span class="p">)</span><span class="o">/</span><span class="n">sph_points_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Noise of the data </span><span class="si">%.2f</span><span class="s2"> per point"</span><span class="o">%</span><span class="k">model_error</span>)
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Noise of the data 1.40 per point
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is using these error can we can optimized the hyper-parameters (optimization parameters), to find which one are best suited for the data.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="2.6-Qualitative-result">2.6 Qualitative result<a class="anchor-link" href="#2.6-Qualitative-result">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We will use <a href="https://plot.ly/python/">plotly</a> to render the result.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [10]:</div>
<div class="inner_cell">
<div class="input_area collapsed"><div class="collapse_expand_button far fa-1x fa-minus-square"></div>
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">## Qualitative results with plotly</span>
<span class="n">_</span><span class="p">,</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">gen_points_from_sph</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    
<span class="n">trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span>
            <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">opacity</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'rgb(50,50,125)'</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'rgb(50,50,125)'</span><span class="p">]])</span>

<span class="n">trace2</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
           <span class="n">x</span><span class="o">=</span><span class="n">sph_points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
           <span class="n">y</span><span class="o">=</span><span class="n">sph_points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
           <span class="n">z</span><span class="o">=</span><span class="n">sph_points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
           <span class="n">mode</span><span class="o">=</span><span class="s1">'markers'</span><span class="p">,</span>
           <span class="n">name</span><span class="o">=</span><span class="s1">'points'</span><span class="p">,</span>
           <span class="n">marker</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">scatter3d</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s1">'circle'</span><span class="p">,</span>
                            <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="s1">'rgb(0,0,255)'</span><span class="p">,</span>
                            <span class="n">opacity</span><span class="o">=</span><span class="mi">1</span><span class="p">),)</span>

<span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">"Sphere fitting"</span><span class="p">,</span>
            <span class="n">scene</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Scene</span><span class="p">(</span>
                <span class="n">aspectmode</span> <span class="o">=</span> <span class="s2">"data"</span><span class="p">,</span>
                <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">"x(mm)"</span><span class="p">,</span>
                <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">"y(mm)"</span><span class="p">,</span>
                <span class="n">zaxis_title</span><span class="o">=</span><span class="s2">"z(mm)"</span><span class="p">,</span>            
                <span class="n">camera</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">))))</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">trace</span><span class="p">,</span> <span class="n">trace2</span><span class="p">],</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="s2">"iframe_connected"</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s1">'showLink'</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_html rendered_html output_subarea">
<iframe allowfullscreen="" frameborder="0" height="545px" scrolling="no" src="/assets/iframes/sphere_fitting/figure_10.html" width="100%"></iframe>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="To-go-further">To go further<a class="anchor-link" href="#To-go-further">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can look at other examples for standard mathematical models <a href="https://www.geometrictools.com/Documentation/LeastSquaresFitting.pdf">here</a>.</p>
</div>
</div>
</div>


<div class="cell border-box-sizing text_cell rendered">
    <div class="prompt input_prompt">
    </div>
    <div class="inner_cell">
    <div class="text_cell_render border-box-sizing rendered_html">
    <h2 id="References">
        References
        <a class="anchor-link" href="#References">
        &#182;
        </a>
    </h2>
    </div>
    </div>
    </div>
    <div class="cell border-box-sizing text_cell rendered">
    <div class="prompt input_prompt">
    </div>
    <div class="inner_cell">
    <div class="text_cell_render border-box-sizing rendered_html">
    <div id="legendre1805nouvelles">
<p>1.&emsp;.Legendre, A.M.: Nouvelles méthodes pour la détermination des orbites des comètes. F. Didot (1805).</p>
</div>
</div>
    </div>
    </div>
    
